<!DOCTYPE html>
<html lang="en">

<head>
    {{ head-tags.html }}
    <title>Stats</title>
    {{ theme-script.html }}
</head>

<body>
    {{ navigation.html }}
    <div class="p-6 text-center">
        <h1 class="text-4xl font-bold mb-16">Stats</h1>
        <div id="stats-container" class="max-content-width m-auto">
            <div id="stats-loader">Loading...</div>
        </div>
    </div>
</body>

<script>{ { index.js } }</script>

<script type="module">
    const statsContainer = document.getElementById("stats-container");
    const statsLoader = document.getElementById("stats-loader");

    function fetchPostsPaths() {
        return fetch("posts.json")
            .then(r => r.json())
            .then(posts => new Set(posts.map(p => `/${p.slug}.html`)))
            .catch(e => {
                console.log("Failed to get posts", e);
                statsLoader.innerHTML = "Failed to get posts";
            });
    }

    function fetchStats() {
        return fetch("/api/stats")
            .then(r => r.json())
            .catch(e => {
                console.log("Failed to get stats", e);
                statsLoader.innerHTML = "Failed to get stats";
            });
    }

    function toStatsView(postsPaths, stats) {
        return {
            views: stats.general.views,
            uniqueVisitors: stats.general.uniqueVisitors,
            posts: stats.pages.filter(p => postsPaths.has(p.path))
                .map(p => {
                    return {
                        title: p.path,
                        views: p.views,
                        uniqueVisitors: p.uniqueVisitors
                    }
                })
        };
    }

    const postsPaths = await fetchPostsPaths();
    const stats = await fetchStats();
    const statsView = toStatsView(postsPaths, stats);

    function renderStats(stats) {
        statsContainer.innerHTML = `
            <div class="mb-16">
                <h2 class="text-3xl mb-4">Overall</h2>
                ${generalStatsComponent(stats)}
            </div>
            <div>
                <h2 class="text-3xl mb-4">Posts</h2>
                ${postsStatsComponent(stats)}
            </div>
        `;
    }

    function generalStatsComponent(stats) {
        return `
            <div>Views: ${stats.views}</div>
            <div>Unique visitors: ${stats.uniqueVisitors}</div>
            `;
    }

    function postsStatsComponent(stats) {
        return `<div class="space-y-8">${stats.posts.map(postStatsComponent).join('\n')}</div>`;
    }

    function postStatsComponent(post) {
        return `
        <div>
            <h3 class="text-xl font-semibold">${post.title}</h3>
            <div>Views: ${post.views}</div>
            <div>Unique visitors: ${post.uniqueVisitors}</div>
            <div class="delimiter-like">---</div>
        </div>
        `;
    }

    renderStats(statsView);
</script>

</html>