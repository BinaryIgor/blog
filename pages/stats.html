<!DOCTYPE html>
<html lang="en">

<head>
    {{ head-tags.html }}
    {{ head-not-indexable-tags.html }}
    <title>Stats</title>
    {{ theme-script.html }}
</head>

<body>
    {{ navigation.html }}
    <div class="p-6 text-center">
        <h1 class="text-4xl font-bold">Stats</h1>
        <div id="stats-container" class="max-content-width m-auto">
            <div id="stats-loader">Loading...</div>
        </div>
    </div>

    {{ init-script.html }}
    <script type="module">
        const TOP_VIEWS_BY_SOURCE = 10;
        const statsContainer = document.getElementById("stats-container");
        const statsLoader = document.getElementById("stats-loader");

        function fetchPosts() {
            return fetch("posts.json")
                .then(r => r.json())
                .then(posts => {
                    const postsByPath = new Map();
                    posts.forEach(p => {
                        postsByPath.set(`/${p.slug}.html`, p);
                    });
                    return postsByPath;
                })
                .catch(e => {
                    console.log("Failed to get posts", e);
                    statsLoader.innerHTML = "Failed to get posts";
                });
        }

        function fetchStats() {
            return fetch(`${apiDomain()}/meta/stats`)
                .then(r => r.json())
                .catch(e => {
                    console.log("Failed to get stats", e);
                    statsLoader.innerHTML = "Failed to get stats";
                });
        }

        function toStatsView(postsByPath, stats) {
            const lastDayStats = stats.periods.lastDay;
            lastDayStats.topViewsBySource = statsTopViewsBySource(lastDayStats);

            const last7DaysStats = stats.periods.last7Days;
            last7DaysStats.topViewsBySource = statsTopViewsBySource(last7DaysStats);

            const last30DaysStats = stats.periods.last30Days;
            last30DaysStats.topViewsBySource = statsTopViewsBySource(last30DaysStats);

            const last90DaysStats = stats.periods.last30Days;
            last90DaysStats.topViewsBySource = statsTopViewsBySource(last90DaysStats);

            const allTimeStats = stats.periods.allTime;
            allTimeStats.topViewsBySource = statsTopViewsBySource(allTimeStats);

            const pagesStats = stats.pages;

            return {
                periods: {
                    lastDay: lastDayStats,
                    last7Days: last7DaysStats,
                    last30Days: last30DaysStats,
                    last90Days: last90DaysStats,
                    allTime: allTimeStats
                },
                posts: pagesStats.filter(p => postsByPath.has(p.path))
                    .map(p => {
                        const post = postsByPath.get(p.path);
                        return {
                            title: post.title,
                            ...p
                        }
                    }),
                pages: pagesStats.filter(p => !postsByPath.has(p.path))
            };
        }

        function statsTopViewsBySource(stats) {
            const limitedViewsBySource = stats.viewsBySource.length > TOP_VIEWS_BY_SOURCE ?
                stats.viewsBySource.slice(0, TOP_VIEWS_BY_SOURCE) : stats.viewsBySource;
            return limitedViewsBySource.map(v => {
                return {
                    source: v.source,
                    views: `${Math.round(v.views * 100) / 100}%`
                }
            });
        }

        const postsByPath = await fetchPosts();
        const stats = await fetchStats();
        const statsView = toStatsView(postsByPath, stats);

        function renderStats(stats) {
            const periods = stats.periods;
            statsContainer.innerHTML = `
                <div class="mb-16">
                    ${periodStatsComponent("Last day", periods.lastDay)}
                    ${periodStatsComponent("Last 7 days", periods.last7Days)}
                    ${periodStatsComponent("Last 30 days", periods.last30Days)}
                    ${periodStatsComponent("Last 90 days", periods.last90Days)}
                    ${periodStatsComponent("All time", periods.allTime)}
                </div>
                <div class="mb-16">
                    <h2 class="text-3xl mb-4 font-bold">Posts</h2>
                    ${postsStatsComponent(stats)}
                </div>
                <div>
                    <h2 class="text-3xl mb-4 font-bold">Pages</h2>
                    ${pagesStatsComponent(stats)}
                </div>
            `;
        }

        function periodStatsComponent(title, stats) {
            return `
                <div class="my-16">
                    <h2 class="text-3xl my-4 font-bold">${title}</h2>
                    <div>Views: ${stats.views}</div>
                    <div>Unique visitors: ${stats.uniqueVisitors}</div>
                    <div>Ip hashes: ${stats.ipHashes}</div>
                    <div>Reads: ${stats.reads}</div>
                    <div>Unique readers: ${stats.uniqueReaders}</div>
                    <div>
                        <h3 class="text-xl mt-4 mb-4 font-bold">View sources</h3>
                        ${viewsBySourceComponent(stats.topViewsBySource)}
                    </div>
                </div>
                `;
        }

        function viewsBySourceComponent(viewsBySource) {
            return `<div class="space-y-8">${viewsBySource.map(viewsOfSourceComponent).join('\n')}</div>`;
        }

        function viewsOfSourceComponent(views, idx) {
            return `
            <div>
                <div>${views.source}: ${views.views}</div>
                ${delimiterComponent()}
            </div>
            `;
        }

        function delimiterComponent() {
            return `<div class="delimiter-like">---</div>`;
        }

        function postsStatsComponent(stats) {
            return `<div class="space-y-8">${stats.posts.map(postStatsComponent).join('\n')}</div>`;
        }

        function postStatsComponent(post) {
            return `
            <div>
                <h3 class="text-xl font-bold">${post.title}</h3>
                <a class="italic font-bold mb-4" href="${post.path}">${post.path}</a>
                <div>Views: ${post.views}</div>
                <div>Reads: ${post.reads}</div>
                <div>Unique viewers: ${post.uniqueViewers}</div>
                <div>Unique readers: ${post.uniqueReaders}</div>
                ${delimiterComponent()}
            </div>
            `;
        }

        function pagesStatsComponent(stats) {
            return `<div class="space-y-8">${stats.pages.map(pageStatsComponent).join('\n')}</div>`;
        }

        function pageStatsComponent(page) {
            return `
            <div>
                <h3 class="text-xl font-bold">${page.path}</h3>
                <div>Views: ${page.views}</div>
                <div>Unique viewers: ${page.uniqueViewers}</div>
                ${delimiterComponent()}
            </div>
            `;
        }

        renderStats(statsView);
    </script>
</body>

</html>